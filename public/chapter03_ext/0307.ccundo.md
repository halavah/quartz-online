# CCUndo - Claude Code精细撤销工具

> 为Claude Code提供精细的撤销功能，直接读取Claude Code会话文件来追踪文件操作，允许用户选择性地撤销更改，恢复到检查点状态

## 目录导航

1. [什么是 CCUndo？](#1-什么是-ccundo)
2. [核心功能特性](#2-核心功能特性)
3. [工作原理](#3-工作原理)
4. [安装指南](#4-安装指南)
5. [使用方法](#5-使用方法)
6. [高级功能](#6-高级功能)
7. [故障排除](#7-故障排除)

## 1. 什么是 CCUndo？

CCUndo 是专为 Claude Code 设计的精细撤销工具，解决了 Claude Code 缺乏原生撤销功能的问题。通过直接读取 Claude Code 的会话文件，CCUndo 能够准确追踪所有的文件操作，并为用户提供选择性撤销更改的能力。

### 核心价值

- **精细撤销**：选择性撤销特定文件或操作的更改
- **会话追踪**：自动追踪 Claude Code 会话中的所有文件操作
- **检查点恢复**：恢复到任意检查点状态
- **无Git依赖**：即使在没有使用 Git 的项目中也能工作
- **Token节省**：避免浪费 tokens 在撤销操作上

### 解决的痛点

1. **缺乏撤销功能**：Claude Code 没有原生的撤销/重做功能
2. **操作不可逆**：错误的代码更改难以快速恢复
3. **会话丢失**：重要的会话状态无法恢复
4. **Git依赖**：传统的撤销方法依赖 Git 版本控制
5. **时间成本**：手动恢复更改耗时耗力

## 2. 核心功能特性

### 🔄 智能文件追踪
- **实时监控**：实时监控 Claude Code 的文件操作
- **操作记录**：详细记录每个文件的所有更改
- **变更对比**：显示文件前后的差异
- **时间戳记录**：精确记录每个操作的时间

### 🎯 选择性撤销
- **文件级别撤销**：选择特定文件进行撤销
- **操作级别撤销**：撤销特定的操作或命令
- **批量撤销**：一次性撤销多个文件的更改
- **部分撤销**：撤销文件中的部分更改

### 📋 检查点管理
- **自动检查点**：自动创建关键时间点的检查点
- **手动检查点**：用户可以手动创建检查点
- **检查点列表**：显示所有可用的检查点
- **快速恢复**：一键恢复到任意检查点

### 🖥️ 可视化界面
- **操作历史**：清晰的操作历史时间线
- **差异显示**：直观的文件差异对比
- **交互式选择**：通过界面选择要撤销的操作
- **状态指示**：实时显示当前状态和进度

### 🔒 安全保障
- **备份保护**：撤销前自动创建备份
- **确认机制**：重要操作需要用户确认
- **回滚保护**：防止意外的关键数据丢失
- **权限检查**：验证文件操作权限

### ⚡ 性能优化
- **快速扫描**：快速扫描和分析会话文件
- **缓存机制**：智能缓存提高响应速度
- **增量分析**：只分析变更的部分
- **并行处理**：并行处理多个文件操作

## 3. 工作原理

### 技术架构
```
Claude Code Session Files
    ↓
CCUndo Engine
    ├── File Parser
    ├── Operation Tracker
    ├── Diff Calculator
    └── Checkpoint Manager
    ↓
User Interface
    ├── History Viewer
    ├── Diff Display
    └── Selection Panel
```

### 会话文件分析

#### Claude Code 会话结构
```json
{
  "session_id": "uuid-string",
  "start_time": "2025-12-22T10:00:00Z",
  "operations": [
    {
      "timestamp": "2025-12-22T10:01:00Z",
      "type": "file_edit",
      "file_path": "/path/to/file.py",
      "operation": "modify",
      "old_content": "...",
      "new_content": "..."
    }
  ]
}
```

#### 操作追踪机制
- **文件监控**：监控 Claude Code 的会话目录
- **事件解析**：解析会话文件中的操作事件
- **状态计算**：计算每个时间点的文件状态
- **差异计算**：计算文件内容差异

### 撤销执行流程
```
用户选择要撤销的操作
    ↓
验证操作的安全性和可行性
    ↓
创建当前状态的备份
    ↓
应用逆向操作
    ↓
验证结果
    ↓
更新会话文件
```

## 4. 安装指南

### 4.1 系统要求

#### 支持平台
- **Linux**：Ubuntu 18.04+, CentOS 7+, Debian 9+
- **macOS**：macOS 10.15 或更高版本
- **Windows**：Windows 10 1903 或更高版本

#### 依赖要求
- **Claude Code**：最新版本
- **Node.js**：16.0.0 或更高版本
- **Git**：可选，用于额外功能

### 4.2 安装方式

#### 方式1：npm 全局安装
```bash
# 使用 npm 安装
npm install -g ccundo

# 使用 yarn 安装
yarn global add ccundo

# 验证安装
ccundo --version
```

#### 方式2：源码安装
```bash
# 克隆仓库
git clone https://github.com/RonitSachdev/ccundo.git
cd ccundo

# 安装依赖
npm install

# 全局链接
npm link

# 验证安装
ccundo --version
```

#### 方式3：本地安装
```bash
# 在项目目录中安装
npm install ccundo

# 使用 npx 运行
npx ccundo

# 或添加到 package.json scripts
```

### 4.3 初始配置

#### 基础配置
```bash
# 初始化配置
ccundo init

# 设置 Claude Code 会话目录
ccundo config set session-dir ~/.claude

# 设置备份目录
ccundo config set backup-dir ~/.ccundo/backups

# 启用自动检查点
ccundo config set auto-checkpoint true
```

#### 高级配置
```bash
# 设置检查点间隔（分钟）
ccundo config set checkpoint-interval 10

# 设置最大备份数量
ccundo config set max-backups 50

# 启用详细日志
ccundo config set verbose true

# 设置撤销确认
ccundo config set confirm-undo true
```

### 4.4 验证安装

#### 功能测试
```bash
# 检查 Claude Code 集成
ccundo check-integration

# 扫描当前会话
ccundo scan

# 查看操作历史
ccundo history

# 测试撤销功能
ccundo test-undo
```

## 5. 使用方法

### 5.1 基础使用

#### 查看操作历史
```bash
# 查看所有操作历史
ccundo history

# 查看特定文件的操作历史
ccundo history --file src/main.py

# 查看特定时间段的操作
ccundo history --since "2025-12-22T10:00:00" --until "2025-12-22T11:00:00"

# 查看最近的 10 个操作
ccundo history --limit 10
```

#### 撤销操作
```bash
# 撤销最后一个操作
ccundo undo

# 撤销特定操作（通过ID）
ccundo undo --operation-id 123

# 撤销特定文件的所有更改
ccundo undo --file src/main.py

# 撤销到特定检查点
ccundo undo --checkpoint checkpoint-2025-12-22-10-30
```

#### 检查点管理
```bash
# 创建手动检查点
ccundo checkpoint create "重要的功能实现"

# 列出所有检查点
ccundo checkpoint list

# 恢复到检查点
ccundo checkpoint restore checkpoint-2025-12-22-10-30

# 删除检查点
ccundo checkpoint delete checkpoint-2025-12-22-10-30
```

### 5.2 交互式模式

#### 启动交互界面
```bash
# 启动 TUI 界面
ccundo interactive

# 或者简写
ccundo i
```

#### 交互界面操作
```
┌─────────────────────────────────────────────────────────────┐
│ CCUndo - Claude Code 撤销工具                                │
├─────────────────────────────────────────────────────────────┤
│ [1] 操作历史            [2] 文件状态      [3] 检查点          │
├─────────────────────────────────────────────────────────────┤
│ 操作列表 (按时间排序)                                       │
│ □ 123 | 10:15:30 | modify    | src/main.py    | 添加新函数  │
│ □ 122 | 10:12:15 | create    | src/utils.py    | 创建工具类  │
│ □ 121 | 10:10:00 | modify    | README.md       | 更新文档    │
├─────────────────────────────────────────────────────────────┤
│ [u]撤销选定  [r]恢复检查点  [d]查看差异  [q]退出              │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 高级功能

#### 批量操作
```bash
# 批量撤销多个操作
ccundo batch-undo --operations 121,122,123

# 批量恢复多个文件
ccundo batch-restore --files src/*.py

# 批量创建检查点
ccundo batch-checkpoint --files src/**/*.py
```

#### 差异查看
```bash
# 查看文件差异
ccundo diff --file src/main.py

# 查看操作差异
ccundo diff --operation 123

# 导出差异报告
ccundo diff --export diff-report.html
```

#### 自动化脚本
```bash
#!/bin/bash
# 自动备份脚本

# 每天创建检查点
ccundo checkpoint create "每日备份-$(date +%Y-%m-%d)"

# 清理旧的检查点（保留最近7天）
ccundo checkpoint cleanup --older-than 7d

# 生成操作报告
ccundo report --export daily-report-$(date +%Y-%m-%d).json
```

### 5.4 集成工作流

#### 与 Git 集成
```bash
# 在 Git 操作前创建检查点
git add .
ccundo checkpoint create "pre-commit-$(git rev-parse --short HEAD)"
git commit -m "commit message"

# 撤销 Git 提交（如果需要）
git reset --soft HEAD~1
ccundo undo --checkpoint pre-commit-abc123
```

#### 与 IDE 集成
```json
// VS Code tasks.json
{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "CCUndo History",
      "type": "shell",
      "command": "ccundo",
      "args": ["history", "--limit", "20"],
      "group": "build"
    },
    {
      "label": "CCUndo Interactive",
      "type": "shell",
      "command": "ccundo",
      "args": ["interactive"],
      "group": "build"
    }
  ]
}
```

## 6. 高级功能

### 6.1 自动化功能

#### 自动检查点
```bash
# 启用自动检查点
ccundo config set auto-checkpoint true

# 设置检查点触发条件
ccundo config set checkpoint-triggers "file-save,session-end,operation-count=10"

# 设置自动检查点间隔
ccundo config set checkpoint-interval 15
```

#### 智能备份
```bash
# 配置智能备份策略
ccundo config set smart-backup true

# 设置备份压缩
ccundo config set backup-compression true

# 设置备份加密
ccundo config set backup-encryption true
```

### 6.2 分析和报告

#### 操作分析
```bash
# 生成操作统计报告
ccundo analyze --type operations

# 生成文件变更统计
ccundo analyze --type files

# 生成时间分析报告
ccundo analyze --type timeline
```

#### 性能监控
```bash
# 监控 CCUndo 性能
ccundo monitor

# 检查系统资源使用
ccundo system-info

# 优化建议
ccundo optimize
```

### 6.3 插件系统

#### 创建插件
```javascript
// plugins/example-plugin.js
class ExamplePlugin {
  constructor(ccundo) {
    this.ccundo = ccundo;
  }

  onBeforeUndo(operation) {
    console.log(`准备撤销操作: ${operation.id}`);
    return true; // 返回 true 继续执行
  }

  onAfterUndo(operation, result) {
    console.log(`撤销完成: ${operation.id}, 结果: ${result.success}`);
  }

  onCheckpointCreated(checkpoint) {
    console.log(`检查点已创建: ${checkpoint.id}`);
  }
}

module.exports = ExamplePlugin;
```

#### 使用插件
```bash
# 安装插件
ccundo plugin install example-plugin

# 列出已安装插件
ccundo plugin list

# 启用/禁用插件
ccundo plugin enable example-plugin
ccundo plugin disable example-plugin
```

## 7. 故障排除

### 常见问题

#### 1. 找不到 Claude Code 会话文件
```bash
# 检查 Claude Code 安装
claude --version

# 查找会话目录
ccundo find-sessions

# 手动设置会话目录
ccundo config set session-dir /path/to/claude/sessions
```

#### 2. 撤销操作失败
```bash
# 检查文件权限
ls -la /path/to/file

# 验证操作ID
ccundo history --verify

# 强制撤销（谨慎使用）
ccundo undo --force --operation-id 123
```

#### 3. 检查点恢复失败
```bash
# 检查检查点完整性
ccundo checkpoint verify checkpoint-id

# 修复损坏的检查点
ccundo checkpoint repair checkpoint-id

# 从备份恢复
ccundo restore-from-backup backup-id
```

#### 4. 性能问题
```bash
# 清理缓存
ccundo cache clear

# 优化数据库
ccundo db optimize

# 重建索引
ccundo db rebuild-index
```

### 调试模式

#### 启用详细日志
```bash
# 设置日志级别
ccundo config set log-level debug

# 启用调试模式
ccundo --debug

# 查看日志文件
tail -f ~/.ccundo/logs/ccundo.log
```

#### 诊断工具
```bash
# 运行完整诊断
ccundo doctor

# 检查特定功能
ccundo doctor --check sessions
ccundo doctor --check backups
ccundo doctor --check integration
```

### 配置重置

#### 重置配置
```bash
# 备份当前配置
ccundo config export config-backup.json

# 重置为默认配置
ccundo config reset

# 从备份恢复配置
ccundo config import config-backup.json
```

#### 清理数据
```bash
# 清理所有数据
ccundo clean --all

# 清理旧数据
ccundo clean --older-than 30d

# 清理损坏的数据
ccundo clean --corrupted
```

## 更新日志

### v1.3.0 (最新)
- 🎉 新增交互式 TUI 界面
- ✨ 支持插件系统
- 🔧 改进性能和稳定性
- 🐛 修复多个已知问题

### v1.2.0
- 🚀 新增自动检查点功能
- 📊 操作分析和报告
- 🔍 改进差异显示
- 💾 智能备份策略

### v1.1.0
- ✨ 批量操作支持
- 🎨 改进用户界面
- 🔧 配置管理优化
- 📚 完善文档

### v1.0.0
- 🎉 首个公开发布
- ⚡ 基础撤销功能
- 🔧 会话文件解析
- 📋 操作历史追踪

## 贡献指南

欢迎为 CCUndo 项目贡献代码！

### 开发环境
```bash
# 克隆仓库
git clone https://github.com/RonitSachdev/ccundo.git
cd ccundo

# 安装开发依赖
npm install

# 运行测试
npm test

# 启动开发模式
npm run dev
```

### 代码贡献
1. Fork 项目
2. 创建功能分支
3. 编写测试
4. 提交 Pull Request

### Bug 报告
- 使用 GitHub Issues 报告问题
- 提供详细的重现步骤
- 包含系统环境信息
- 附上相关的错误日志

## 许可证

本项目采用 MIT 许可证。详情请参阅 [LICENSE](https://github.com/RonitSachdev/ccundo/blob/main/LICENSE) 文件。

## 相关资源

- [GitHub 仓库](https://github.com/RonitSachdev/ccundo)
- [教程文章](https://dev.to/ronit_sachdev/how-to-undo-in-claude-code-2cbp)
- [YouTube 视频](https://www.youtube.com/watch?v=uq4R6ZRfdmM)
- [API 文档](https://ccundo.docs.com/)
- [用户社区](https://github.com/RonitSachdev/ccundo/discussions)

## 致谢

感谢以下项目和社区的支持：
- [Claude Code](https://github.com/anthropics/claude-code) - 核心平台
- 开源社区提供的反馈和建议
- 所有测试用户的宝贵意见

---

> 💡 **提示**: CCUndo 是一个活跃开发的开源项目，如果你在使用中遇到问题或有改进建议，欢迎参与讨论和贡献！让 Claude Code 的撤销体验更加完善！