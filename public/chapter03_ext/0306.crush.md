# Crush - 终端AI编程代理工具

> Charm公司开发的终端AI编程代理，集成工具、代码和工作流，支持多AI提供商路由、自定义API端点，为开发者提供强大的编程辅助体验

## 目录导航

1. [什么是 Crush？](#1-什么是-crush)
2. [核心功能特性](#2-核心功能特性)
3. [系统架构](#3-系统架构)
4. [安装指南](#4-安装指南)
5. [配置说明](#5-配置说明)
6. [使用方法](#6-使用方法)
7. [API路由功能](#7-api路由功能)
8. [故障排除](#8-故障排除)

## 1. 什么是 Crush？

Crush 是 Charm 公司开发的一款终端 AI 编程代理工具，旨在为开发者提供一个强大、灵活的 AI 编程助手。它集成了多个 AI 提供商，支持智能路由、自定义 API 端点，并通过优雅的终端界面提供无缝的编程体验。

### 核心价值

- **统一接口**：通过单一工具访问多个 AI 编程助手
- **智能路由**：自动选择最适合的 AI 提供商和模型
- **终端集成**：完美融入开发者的终端工作流
- **高性能**：优化的性能和响应速度
- **可扩展性**：支持自定义插件和扩展

### 设计理念

Crush 遵循 Charm 公司的设计哲学：
- **简洁优雅**：界面简洁，操作直观
- **功能强大**：功能丰富但不复杂
- **性能优先**：注重性能和用户体验
- **开源精神**：开源社区驱动发展

## 2. 核心功能特性

### 🤖 多AI提供商支持
- **OpenAI**：支持 GPT-4、GPT-3.5 等模型
- **Anthropic**：支持 Claude 系列模型
- **OpenRouter**：支持 OpenRouter 平台的所有模型
- **自定义端点**：支持兼容 OpenAI API 的自定义服务
- **本地模型**：支持 Ollama 等本地模型服务

### 🛣️ 智能API路由
- **自动选择**：根据任务类型自动选择最适合的模型
- **成本优化**：支持 `:floor` 路由到最便宜的提供商
- **性能优化**：支持 `:nitro` 路由到最快的提供商
- **负载均衡**：在多个提供商间智能分配请求
- **故障转移**：自动切换到备用提供商

### 💻 终端用户体验
- **TUI界面**：美观的终端用户界面
- **CLI模式**：支持纯命令行操作
- **交互式对话**：自然语言交互体验
- **语法高亮**：代码语法高亮显示
- **快捷键支持**：丰富的键盘快捷键

### 🔧 开发者工具集成
- **Git集成**：与 Git 工作流深度集成
- **文件操作**：直接的文件读写和编辑功能
- **代码分析**：代码理解和分析能力
- **测试生成**：自动生成单元测试
- **文档生成**：自动生成代码文档

### ⚡ 高级功能
- **多文件处理**：同时处理多个文件
- **项目管理**：项目级别的上下文理解
- **代码重构**：智能代码重构建议
- **性能优化**：代码性能分析和优化建议
- **安全扫描**：代码安全性检查

### 🎨 可定制性
- **主题支持**：多种终端主题
- **配置管理**：灵活的配置选项
- **插件系统**：支持自定义插件
- **脚本支持**：支持自动化脚本
- **API扩展**：开放的 API 接口

## 3. 系统架构

### 技术架构
```
Terminal Interface (Bubble Tea)
    ↓
Core Engine (Go)
    ├── Router Module
    ├── Provider Manager
    ├── Context Manager
    └── Plugin System
    ↓
AI Providers
    ├── OpenAI API
    ├── Anthropic API
    ├── OpenRouter API
    └── Custom APIs
```

### 核心组件

#### 路由模块 (Router Module)
- **请求分析**：分析用户请求类型和复杂度
- **模型选择**：根据任务选择最适合的模型
- **负载均衡**：在多个提供商间分配负载
- **故障处理**：处理 API 故障和限流

#### 提供商管理器 (Provider Manager)
- **API集成**：集成多个 AI 提供商 API
- **认证管理**：管理不同提供商的认证信息
- **配置管理**：管理提供商特定配置
- **性能监控**：监控提供商性能指标

#### 上下文管理器 (Context Manager)
- **文件上下文**：理解文件内容和结构
- **项目上下文**：理解项目整体结构
- **对话历史**：维护对话历史记录
- **上下文优化**：优化上下文长度和内容

#### 插件系统 (Plugin System)
- **插件加载**：动态加载和管理插件
- **API接口**：提供插件开发 API
- **事件系统**：基于事件的插件通信
- **安全沙箱**：插件安全执行环境

## 4. 安装指南

### 4.1 系统要求

#### 支持平台
- **Linux**：Ubuntu 18.04+, CentOS 7+, Debian 9+
- **macOS**：macOS 10.15 或更高版本
- **Windows**：Windows 10 1903 或更高版本 (通过 WSL)

#### 硬件要求
- **处理器**：64位 CPU
- **内存**：4GB RAM (推荐 8GB)
- **存储空间**：100MB 可用空间
- **网络**：稳定的互联网连接

### 4.2 安装方式

#### 方式1：预编译二进制文件

##### Linux/macOS 安装
```bash
# 下载最新版本
curl -L https://github.com/charmbracelet/crush/releases/latest/download/crush-linux-amd64.tar.gz | tar xz

# 移动到系统路径
sudo mv crush /usr/local/bin/

# 验证安装
crush --version
```

##### macOS 使用 Homebrew
```bash
# 安装
brew install charmbracelet/tap/crush

# 升级
brew upgrade crush
```

#### 方式2：从源码编译

##### 前置要求
- Go 1.21 或更高版本
- Git

##### 编译安装
```bash
# 克隆仓库
git clone https://github.com/charmbracelet/crush.git
cd crush

# 编译
go build -o crush ./cmd/crush

# 安装到系统路径
sudo mv crush /usr/local/bin/
```

#### 方式3：包管理器安装

##### 使用 Go 安装
```bash
# 安装最新版本
go install github.com/charmbracelet/crush@latest

# 验证安装
crush --version
```

### 4.3 验证安装

#### 基础验证
```bash
# 检查版本
crush --version

# 查看帮助
crush --help

# 检查配置
crush config check
```

#### 功能测试
```bash
# 启动交互模式
crush

# 测试简单查询
crush "Hello, how are you?"

# 检查提供商状态
crush providers status
```

## 5. 配置说明

### 5.1 基础配置

#### 配置文件位置
- **Linux/macOS**: `~/.config/crush/config.yaml`
- **Windows**: `%APPDATA%/crush/config.yaml`

#### 基础配置示例
```yaml
# crush/config.yaml
providers:
  openai:
    api_key: "sk-your-openai-key"
    models:
      - "gpt-4"
      - "gpt-3.5-turbo"
    base_url: "https://api.openai.com/v1"

  anthropic:
    api_key: "sk-ant-your-anthropic-key"
    models:
      - "claude-3-opus-20240229"
      - "claude-3-sonnet-20240229"
    base_url: "https://api.anthropic.com"

  openrouter:
    api_key: "sk-or-your-openrouter-key"
    models:
      - "anthropic/claude-3-opus"
      - "openai/gpt-4"
    base_url: "https://openrouter.ai/api/v1"

router:
  default_provider: "openrouter"
  auto_routing: true
  cost_optimization: false
  performance_optimization: false

ui:
  theme: "auto"
  syntax_highlighting: true
  line_numbers: true
```

### 5.2 高级配置

#### 路由策略配置
```yaml
router:
  strategies:
    coding:
      preferred_provider: "anthropic"
      models: ["claude-3-opus-20240229"]
      fallback: ["openrouter:anthropic/claude-3-opus", "openai:gpt-4"]

    analysis:
      preferred_provider: "openai"
      models: ["gpt-4"]
      fallback: ["openrouter:openai/gpt-4", "anthropic:claude-3-sonnet"]

    simple:
      preferred_provider: "openrouter"
      models: ["openrouter:anthropic/claude-3-haiku:nitro"]
      fallback: ["openai:gpt-3.5-turbo:floor"]

  cost_optimization:
    enabled: true
    max_cost_per_request: 0.01
    preferred_cheapest: true

  performance_optimization:
    enabled: true
    max_response_time: 5000  # milliseconds
    preferred_fastest: true
```

#### 自定义提供商配置
```yaml
providers:
  custom_llama:
    type: "openai_compatible"
    api_key: "your-key"
    base_url: "http://localhost:11434/v1"
    models:
      - "llama2:7b"
      - "codellama:7b"
    timeout: 60
    max_retries: 3

  custom_proxy:
    type: "openai_compatible"
    api_key: "your-proxy-key"
    base_url: "https://your-proxy.com/v1"
    models:
      - "gpt-4"
      - "claude-3-opus"
    headers:
      "X-Custom-Header": "value"
```

### 5.3 环境变量配置

```bash
# OpenAI 配置
export OPENAI_API_KEY="sk-your-openai-key"
export OPENAI_BASE_URL="https://api.openai.com/v1"

# Anthropic 配置
export ANTHROPIC_API_KEY="sk-ant-your-anthropic-key"

# OpenRouter 配置
export OPENROUTER_API_KEY="sk-or-your-openrouter-key"

# Crush 全局配置
export CRUSH_CONFIG_PATH="/path/to/config.yaml"
export CRUSH_LOG_LEVEL="info"
export CRUSH_CACHE_DIR="/path/to/cache"
```

## 6. 使用方法

### 6.1 基础使用

#### 交互式模式
```bash
# 启动交互式会话
crush

# 启动时指定提供商
crush --provider anthropic

# 启动时指定模型
crush --model claude-3-opus-20240229

# 加载项目上下文
crush --context ./my-project
```

#### 命令行模式
```bash
# 简单查询
crush "解释这段代码的功能"

# 代码分析
crush --file main.go "分析这段代码的性能"

# 代码生成
crush "生成一个快速排序算法" --language go

# 文件操作
crush "重构这个函数" --file utils.py
```

### 6.2 高级功能

#### 项目级别操作
```bash
# 分析整个项目
crush --project ./my-project "分析这个项目的架构"

# 生成项目文档
crush --project ./my-project "生成API文档"

# 代码审查
crush --project ./my-project "进行代码审查"

# 优化建议
crush --project ./my-project "提供性能优化建议"
```

#### 多文件处理
```bash
# 处理多个文件
crush --files "*.go" "重构这些Go文件"

# 批量代码分析
crush --files "src/**/*.py" "分析Python代码质量"

# 跨语言项目分析
crush --files "src/**/*" "分析多语言项目结构"
```

#### Git 集成
```bash
# 分析Git差异
crush --git-diff "解释这些变更的影响"

# 生成提交信息
crush --git-diff "生成合适的提交信息"

# 代码审查
crush --git-pr "审查这个Pull Request"

# 分支合并建议
crush --git-diff main..feature "评估合并风险"
```

### 6.3 插件使用

#### 查看可用插件
```bash
# 列出已安装插件
crush plugins list

# 查看插件详情
crush plugins info plugin-name

# 安装插件
crush plugins install plugin-name

# 卸载插件
crush plugins uninstall plugin-name
```

#### 插件开发示例
```go
// plugins/example/main.go
package main

import (
    "github.com/charmbracelet/crush/pkg/plugin"
)

func main() {
    plugin.Register(&ExamplePlugin{})
}

type ExamplePlugin struct{}

func (p *ExamplePlugin) Name() string {
    return "example"
}

func (p *ExamplePlugin) Execute(ctx plugin.Context, args []string) error {
    // 插件逻辑
    return nil
}
```

## 7. API路由功能

### 7.1 OpenRouter 集成

#### 特殊路由后缀
```bash
# 路由到最快的提供商
crush --provider "openrouter:anthropic/claude-3-opus:nitro" "快速响应"

# 路由到最便宜的提供商
crush --provider "openrouter:openai/gpt-4:floor" "成本优化"

# 路由到特定提供商
crush --provider "openrouter:anthropic/claude-3-sonnet" "标准响应"
```

#### OpenRouter 配置
```yaml
providers:
  openrouter:
    api_key: "sk-or-your-key"
    base_url: "https://openrouter.ai/api/v1"
    models:
      - "anthropic/claude-3-opus:nitro"
      - "anthropic/claude-3-opus:floor"
      - "openai/gpt-4:nitro"
      - "openai/gpt-4:floor"
    timeout: 30
    max_retries: 3
```

### 7.2 自定义API端点

#### 代理配置示例
```yaml
providers:
  custom_proxy:
    type: "openai_compatible"
    api_key: "your-proxy-key"
    base_url: "https://your-proxy.company.com/v1"
    models:
      - "gpt-4"
      - "claude-3-opus"
    headers:
      "X-Proxy-Token": "your-proxy-token"
      "X-User-ID": "your-user-id"
    timeout: 60
    max_retries: 3
    verify_ssl: false  # 如果使用自签名证书
```

#### Gemini 自定义提供商
```yaml
providers:
  gemini_custom:
    type: "openai_compatible"
    api_key: "your-gemini-key"
    base_url: "https://your-gemini-proxy.com/v1"
    models:
      - "gemini-pro"
      - "gemini-pro-vision"
    headers:
      "X-Gemini-Version": "v1"
    timeout: 45
```

### 7.3 负载均衡和故障转移

#### 负载均衡配置
```yaml
router:
  load_balancing:
    strategy: "round_robin"  # round_robin, random, weighted
    providers:
      - name: "anthropic"
        weight: 2
        models: ["claude-3-opus-20240229"]
      - name: "openrouter"
        weight: 1
        models: ["openrouter:anthropic/claude-3-opus"]

    health_check:
      enabled: true
      interval: 60  # seconds
      timeout: 10   # seconds
```

#### 故障转移配置
```yaml
router:
  failover:
    enabled: true
    max_retries: 3
    retry_delay: 1000  # milliseconds
    providers:
      primary: "anthropic"
      secondary: ["openrouter", "openai"]
    conditions:
      - "timeout"
      - "rate_limit"
      - "error"
```

### 7.4 成本和性能优化

#### 成本优化策略
```yaml
cost_optimization:
  enabled: true
  max_cost_per_hour: 1.0  # USD
  preferred_cheapest: true
  budget_alerts: true

  provider_costs:
    anthropic:
      claude-3-opus: 0.015  # per 1K tokens
      claude-3-sonnet: 0.003
    openai:
      gpt-4: 0.03
      gpt-3.5-turbo: 0.002
```

#### 性能优化策略
```yaml
performance_optimization:
  enabled: true
  max_response_time: 5000  # milliseconds
  preferred_fastest: true
  caching:
    enabled: true
    ttl: 3600  # seconds
    max_size: 1000  # MB
```

## 8. 故障排除

### 常见问题

#### 1. API 连接失败
```bash
# 检查网络连接
curl -I https://api.openai.com/v1/models

# 验证 API 密钥
crush providers test openai

# 检查配置文件
crush config check

# 查看详细日志
crush --log-level debug
```

#### 2. 路由不工作
```bash
# 检查路由配置
crush router status

# 测试路由策略
crush router test --query "test query"

# 查看提供商状态
crush providers status

# 重置路由缓存
crush router cache clear
```

#### 3. 插件问题
```bash
# 列出插件
crush plugins list

# 检查插件状态
crush plugins status

# 重载插件
crush plugins reload

# 卸载有问题的插件
crush plugins uninstall problematic-plugin
```

#### 4. 性能问题
```bash
# 查看性能统计
crush stats

# 清理缓存
crush cache clear

# 检查资源使用
crush system info

# 优化配置
crush optimize
```

### 调试模式

#### 启用调试日志
```bash
# 设置日志级别
export CRUSH_LOG_LEVEL=debug

# 启动调试模式
crush --debug

# 查看日志文件
tail -f ~/.local/share/crush/logs/crush.log
```

#### 网络调试
```bash
# 测试网络连接
crush network test

# 检查API延迟
crush network latency

# 测试提供商
crush providers test --all
```

### 配置重置

#### 重置配置
```bash
# 备份当前配置
cp ~/.config/crush/config.yaml ~/.config/crush/config.yaml.backup

# 重置为默认配置
crush config reset

# 重新配置
crush config setup
```

#### 清理数据
```bash
# 清理缓存
crush cache clear --all

# 清理日志
crush logs clear

# 重置所有数据
crush reset --hard
```

## 更新日志

### v2.1.0 (最新)
- 🎉 新增 OpenRouter 路由支持
- ✨ 支持 `:nitro` 和 `:floor` 路由后缀
- 🔧 改进自定义提供商配置
- 🐛 修复 Gemini 自定义提供商问题

### v2.0.0
- 🚀 全新的路由引擎
- ✨ 多提供商负载均衡
- 🎨 重构用户界面
- 📊 性能监控面板

### v1.5.0
- 💾 插件系统支持
- 🔍 项目上下文理解
- 📱 改进终端界面
- 🔧 配置管理优化

### v1.0.0
- 🎉 首个公开发布
- ⚡ 基础 AI 编程功能
- 🔧 多提供商支持
- 📚 完整文档

## 贡献指南

欢迎为 Crush 项目贡献代码！

### 开发环境
```bash
# 克隆仓库
git clone https://github.com/charmbracelet/crush.git
cd crush

# 安装依赖
go mod download

# 运行测试
go test ./...

# 构建开发版本
go build -o crush ./cmd/crush
```

### 代码贡献
1. Fork 项目
2. 创建功能分支
3. 编写测试
4. 提交 Pull Request
5. 代码审查

### 插件开发
- 参考 [插件开发文档](https://github.com/charmbracelet/crush/blob/main/docs/PLUGINS.md)
- 使用插件模板快速开始
- 遵循插件开发规范

## 许可证

本项目采用 MIT 许可证。详情请参阅 [LICENSE](https://github.com/charmbracelet/crush/blob/main/LICENSE) 工作区。

## 相关资源

- [GitHub 仓库](https://github.com/charmbracelet/crush)
- [Charm 官方网站](https://charm.sh/)
- [Bubble Tea TUI 框架](https://github.com/charmbracelet/bubbletea)
- [Lipgloss 样式库](https://github.com/charmbracelet/lipgloss)
- [用户社区](https://github.com/charmbracelet/crush/discussions)

## 致谢

感谢 Charm 公司和开源社区的支持！特别感谢：
- Bubble Tea 社区提供的优秀 TUI 框架
- 所有贡献者的代码和反馈
- 用户提供的宝贵使用建议

---

> 💡 **提示**: Crush 是一个活跃开发的开源项目，如果你觉得有用，请考虑给项目一个 Star，或者参与贡献代码！让终端 AI 编程体验更加美好！