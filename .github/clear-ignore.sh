#!/bin/bash
# ========================================================================
# clear-ignore.sh - Git å¿½ç•¥æ–‡ä»¶æ¸…ç†å·¥å…·
# ========================================================================
# åŠŸèƒ½è¯´æ˜ï¼š
#   æ ¹æ® .gitignore å†…å®¹ï¼Œç§»é™¤å·²è¢« Git è·Ÿè¸ªä½†åº”è¯¥è¢«å¿½ç•¥çš„æ–‡ä»¶
#
# å·¥ä½œæµç¨‹ï¼š
#   1. æ£€æŸ¥æ˜¯å¦åœ¨ Git ä»“åº“ä¸­
#   2. æ£€æŸ¥ .gitignore æ–‡ä»¶æ˜¯å¦å­˜åœ¨
#   3. ä½¿ç”¨ Git å†…ç½®åŠŸèƒ½æŸ¥æ‰¾åº”è¯¥è¢«å¿½ç•¥ä½†è¢«è·Ÿè¸ªçš„æ–‡ä»¶
#   4. ç§»é™¤è¿™äº›æ–‡ä»¶çš„ Git è·Ÿè¸ª
#
# è¿è¡Œæ–¹å¼ï¼š
#   ./clear-ignore.sh
#
# æ³¨æ„äº‹é¡¹ï¼š
#   - åªç§»é™¤ Git è·Ÿè¸ªï¼Œä¸ä¼šåˆ é™¤æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶
#   - ç§»é™¤åéœ€è¦æäº¤æ›´æ”¹æ‰èƒ½ç”Ÿæ•ˆ
#   - å»ºè®®åœ¨æ‰§è¡Œå‰å…ˆæäº¤å½“å‰æ›´æ”¹
#   - å¦‚éœ€ .gitignore æ¨¡æ¿å‚è€ƒï¼Œè¯·æŸ¥çœ‹ gitignore-template-*.txt
# ========================================================================

set -e

# åˆ‡æ¢åˆ°è„šæœ¬æ‰€åœ¨ç›®å½•
cd "$(dirname "$0")"

# åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•
cd ..

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Git å¿½ç•¥æ–‡ä»¶æ¸…ç†å·¥å…·"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# æ£€æŸ¥æ˜¯å¦åœ¨ Git ä»“åº“ä¸­
echo "ğŸ” æ£€æŸ¥ Git ä»“åº“çŠ¶æ€..."
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo ""
    echo "âŒ é”™è¯¯ï¼šå½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“"
    echo ""
    read -p "æŒ‰å›è½¦é”®é€€å‡º"
    exit 1
fi
echo "âœ… Git ä»“åº“æ£€æŸ¥é€šè¿‡"
echo ""

# æ£€æŸ¥ .gitignore æ–‡ä»¶æ˜¯å¦å­˜åœ¨
echo "ğŸ” æ£€æŸ¥ .gitignore æ–‡ä»¶..."
if [ ! -f ".gitignore" ]; then
    echo ""
    echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° .gitignore æ–‡ä»¶"
    echo ""
    echo "ğŸ’¡ æç¤ºï¼šè¯·å…ˆåˆ›å»º .gitignore æ–‡ä»¶"
    echo ""
    read -p "æŒ‰å›è½¦é”®é€€å‡º"
    exit 1
fi
echo "âœ… æ‰¾åˆ° .gitignore æ–‡ä»¶"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å¼€å§‹æ¸…ç† Git è·Ÿè¸ª
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  å¼€å§‹æ¸…ç† Git è·Ÿè¸ªçš„å¿½ç•¥æ–‡ä»¶"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# åˆ›å»ºä¸´æ—¶æ–‡ä»¶
TEMP_FILES=$(mktemp)

echo "ğŸ“‹ æ­¥éª¤ 1/3ï¼šæŸ¥æ‰¾åŒ¹é… .gitignore çš„è¢«è·Ÿè¸ªæ–‡ä»¶..."
echo ""

# ä½¿ç”¨ Git å†…ç½®å‘½ä»¤æŸ¥æ‰¾æ‰€æœ‰è¢«è·Ÿè¸ªä½†åŒ¹é… .gitignore çš„æ–‡ä»¶
git ls-files -i -c --exclude-standard > "$TEMP_FILES" 2>/dev/null

echo "ğŸ” æ­¥éª¤ 2/3ï¼šåˆ†æå‘ç°çš„æ–‡ä»¶..."
echo ""

# æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦ç§»é™¤çš„æ–‡ä»¶
if [ -s "$TEMP_FILES" ]; then
    file_count=$(wc -l < "$TEMP_FILES" | tr -d ' ')
    echo "âœ… æ‰¾åˆ° $file_count ä¸ªæ–‡ä»¶åŒ¹é… .gitignore è§„åˆ™ä½†ä»è¢« Git è·Ÿè¸ª"
    echo ""
    echo "è¿™äº›æ–‡ä»¶å°†è¢«ä» Git è·Ÿè¸ªä¸­ç§»é™¤ï¼ˆæœ¬åœ°æ–‡ä»¶ä¸ä¼šè¢«åˆ é™¤ï¼‰ï¼š"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    while IFS= read -r file; do
        echo "  $file"
    done < "$TEMP_FILES"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo ""

    # è¯¢é—®ç”¨æˆ·ç¡®è®¤
    read -p "â“ ç¡®å®šè¦ç§»é™¤è¿™äº›æ–‡ä»¶çš„ Git è·Ÿè¸ªå—ï¼Ÿ(y/Nï¼Œé»˜è®¤N): " -n 1 -r
    echo
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "ğŸ—‘ï¸  æ­¥éª¤ 3/3ï¼šç§»é™¤ Git è·Ÿè¸ª..."
        echo ""

        # è¯»å–æ–‡ä»¶å¹¶ç§»é™¤è·Ÿè¸ª
        success_count=0
        failed_count=0

        while IFS= read -r file; do
            if [ -n "$file" ]; then
                if git rm --cached -r --ignore-unmatch "$file" > /dev/null 2>&1; then
                    echo "âœ… ç§»é™¤è·Ÿè¸ª: $file"
                    success_count=$((success_count + 1))
                else
                    echo "âš ï¸  è­¦å‘Šï¼šæ— æ³•ç§»é™¤ $file"
                    failed_count=$((failed_count + 1))
                fi
            fi
        done < "$TEMP_FILES"

        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  âœ… æ¸…ç†å®Œæˆï¼"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“Š å¤„ç†ç»“æœï¼š"
        echo "   æˆåŠŸç§»é™¤ï¼š$success_count ä¸ª"
        if [ $failed_count -gt 0 ]; then
            echo "   å¤±è´¥ï¼š$failed_count ä¸ª"
        fi
        echo ""
        echo "ğŸ“Œ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
        echo "   1. æŸ¥çœ‹çŠ¶æ€: git status"
        echo "   2. æŸ¥çœ‹æ›´æ”¹: git diff --cached"
        echo "   3. æäº¤æ›´æ”¹: git commit -m \"chore: remove ignored files from Git tracking\""
        echo ""
        echo "ğŸ’¡ æç¤ºï¼š"
        echo "   â€¢ è¿™äº›æ–‡ä»¶ä»ä¿ç•™åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­"
        echo "   â€¢ å®ƒä»¬ä¸ä¼šå†è¢« Git è·Ÿè¸ª"
        echo "   â€¢ æäº¤åï¼Œè¿™äº›æ–‡ä»¶å°†ä»è¿œç¨‹ä»“åº“ä¸­åˆ é™¤ï¼ˆä½†æœ¬åœ°ä¿ç•™ï¼‰"
    else
        echo "âŒ æ“ä½œå·²å–æ¶ˆ"
    fi
else
    echo "âœ… å¤ªå¥½äº†ï¼æ²¡æœ‰æ‰¾åˆ°éœ€è¦ç§»é™¤çš„è¢«è·Ÿè¸ªæ–‡ä»¶"
    echo ""
    echo "è¿™æ„å‘³ç€ï¼š"
    echo "   â€¢ æ‰€æœ‰è¢« Git è·Ÿè¸ªçš„æ–‡ä»¶éƒ½ä¸åœ¨ .gitignore è§„åˆ™ä¸­"
    echo "   â€¢ æˆ–è€… .gitignore è§„åˆ™å·²ç»æ­£ç¡®ç”Ÿæ•ˆ"
fi

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -f "$TEMP_FILES"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  è„šæœ¬æ‰§è¡Œå®Œæˆ"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
read -p "æŒ‰å›è½¦é”®é€€å‡º"
